# Session Utilities

Crash recovery and multi-tab blocking utilities for workout sessions.

## Barrel Export

```typescript
import {
  persist,
  restore,
  clearPersisted,
  extractSessionState,
  getSessionGuard,
  SessionGuard,
} from '@/lib/session';

// For React components, use the hook from @/hooks instead:
import { useMultiTabGuard } from '@/hooks/useMultiTabGuard';
```

## Session Persistence (Crash Recovery)

localStorage-based persistence with 5-minute resume window.

| Export | Purpose |
|--------|---------|
| `persist(state)` | Save session state to localStorage |
| `restore()` | Restore session if within 5-minute window, returns `SessionState \| null` |
| `clearPersisted()` | Remove persisted session from localStorage |
| `getPersistedSessionAge()` | Get age of persisted session in ms |
| `RESUME_WINDOW_MS` | 5 minute constant (300,000 ms) |
| `STORAGE_KEYS` | localStorage key constants |

```typescript
// Persist current session
persist(sessionState);

// Check for recoverable session
const restored = restore();
if (restored) {
  // Apply to session store
}

// Clear on session end
clearPersisted();
```

## Session Guard (Multi-Tab Blocking)

BroadcastChannel-based mutex to prevent concurrent workouts across tabs.

| Export | Purpose |
|--------|---------|
| `SessionGuard` | Class managing multi-tab blocking |
| `sessionGuard` | Singleton instance |
| `getSessionGuard()` | Get singleton (SSR-safe) |
| `useSessionGuard()` | React hook for components |

### SessionGuard API

```typescript
const guard = getSessionGuard();

// Attempt to claim ownership (returns false if another tab owns)
const success = await guard.claim();

// Release when done
guard.release();

// Check state
guard.isOwner;      // boolean
guard.hasConflict;  // boolean

// Cleanup
guard.destroy();
```

### useMultiTabGuard Hook (from @/hooks)

For React components, use the `useMultiTabGuard` hook instead of SessionGuard directly:

```typescript
import { useMultiTabGuard } from '@/hooks/useMultiTabGuard';

const { isOwner, hasConflict, isClaiming, claim, release, forceTakeOver } = useMultiTabGuard();

// Show blocking modal when conflict detected
if (hasConflict) {
  return <BlockedModal onTakeOver={forceTakeOver} />;
}
```

## Message Protocol

BroadcastChannel messages use these types:
- `CLAIM` - Tab requesting session ownership
- `CONFLICT` - Owner tab rejecting claim
- `RELEASE` - Owner releasing session
- `HEARTBEAT` - Keep-alive (every 10s, timeout at 15s)

## Files

```
src/lib/session/
  session-persistence.ts  # localStorage crash recovery
  session-guard.ts        # BroadcastChannel multi-tab blocking
  index.ts               # Barrel export
  __tests__/             # Test files
```

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>